<!DOCTYPE html>
<html lang="en" class="bg-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Link Shortener</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex items-center justify-center h-screen">
  <!-- Login Screen -->
  <div id="login-screen" class="bg-white p-6 rounded-xl shadow-md w-full max-w-md">
    <h2 class="text-2xl font-semibold mb-4 text-center">Enter Access Password</h2>
    <input id="password-input" type="password" placeholder="Password" class="w-full p-2 border rounded mb-4 focus:outline-none focus:ring" />
    <button onclick="verifyPassword()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Login</button>
    <p id="error-msg" class="text-red-500 mt-2 text-sm hidden">Incorrect password</p>
  </div>

  <!-- Main App Screen -->
  <div id="app-screen" class="hidden bg-white p-6 rounded-xl shadow-md w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4 text-center">Link Shortener</h2>
    <input id="url-input" type="url" placeholder="Enter a long URL" class="w-full p-2 border rounded mb-3 focus:outline-none focus:ring" />
    <input id="alias-input" type="text" placeholder="Custom alias (optional)" class="w-full p-2 border rounded mb-4 focus:outline-none focus:ring" />
    <button onclick="shortenUrl()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Shorten</button>
    <div id="result" class="mt-4 text-center text-gray-700 font-mono"></div>
  </div>

  <script>
    // LocalStorage yönetimi için yardımcı fonksiyonlar
    const storageKey = 'linkShortenerData';
    const storedHash = "715d19bffe53f3abc8c0addfa9f162021277eb14a8e7992f888c2929f02783d29e0b0d3bd0e3816eb008bbff3b43874f7e066b7d99de20c8b44a25bef05fd52f";

    function loadLinks() {
      const data = localStorage.getItem(storageKey);
      return data ? JSON.parse(data).links : {};
    }

    function saveLinks(links) {
      const data = JSON.stringify({ links, hash: storedHash });
      localStorage.setItem(storageKey, data);
    }

    let links = loadLinks();

    window.onload = function() {
      const path = window.location.pathname;
      
      if (path.startsWith('/link/')) {
        const alias = path.split('/link/')[1];
        if (links[alias]) {
          window.location.href = links[alias];
        } else {
          document.body.innerHTML = `<div class="text-center p-8">Alias not found</div>`;
        }
      }
    };

    async function verifyPassword() {
      const input = document.getElementById('password-input').value.trim();
      const encoded = btoa(input);
      const buffer = new TextEncoder().encode(encoded);
      const hashBuffer = await crypto.subtle.digest('SHA-512', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      if (hashHex === storedHash) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
      } else {
        document.getElementById('error-msg').classList.remove('hidden');
      }
    }

    function shortenUrl() {
      const url = document.getElementById('url-input').value.trim();
      let alias = document.getElementById('alias-input').value.trim();

      if (!url) return;

      if (alias) {
        if (links[alias]) {
          document.getElementById('result').textContent = `Alias "${alias}" already exists. Try another.`;
          return;
        }
      } else {
        do {
          alias = Math.random().toString(36).substring(2, 7);
        } while (links[alias]);
      }

      links[alias] = url;
      saveLinks(links);

      const shortUrl = `${location.origin}/link/${alias}`;
      document.getElementById('result').innerHTML = `Short URL: <a href="${shortUrl}" class="text-blue-600 underline" target="_blank">${shortUrl}</a>`;
      
      // Input alanlarını temizle
      document.getElementById('url-input').value = '';
      document.getElementById('alias-input').value = '';
    }
  </script>
</body>
</html>
